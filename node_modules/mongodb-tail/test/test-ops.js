
'use strict';

const mongodb = require('mongodb');

mongodb.connect('mongodb://localhost:27001,localhost:27002/test?replicaSet=rs', (err, db) => {
  if (err) throw err;
  const docsNum = 1000, timeout = 100;
  let tick = 0;
  const collection = db.collection('test');
  const insert = collection.insertMany || collection.insert;
  const update = collection.updateMany || collection.update;
  const remove = collection.deleteMany || collection.remove;
  const insertDocs = (cb) => insert.call(collection, Array.apply(null, new Array(docsNum)).map((n, i) => ({ i: i })), cb);
  const updateDocs = (cb) => update.call(collection, {}, { $inc: { i: 1 } }, cb);
  const removeDocs = (cb) => remove.call(collection, {}, cb);
  const go = (cb) => {
    console.log('tick:', ++tick);
    removeDocs((err) => {
      if (err) return cb(err);
      insertDocs((err) => {
        if (err) return cb(err);
        updateDocs((err) => {
          if (err) return cb(err);
          setTimeout(go.bind(null, cb), timeout);
        });
      });
    });
  };
  go((err) => { throw err; });
  process.on('SIGINT', () => {
    db.close();
    console.log('exit');
    process.exit(0);
  });
});